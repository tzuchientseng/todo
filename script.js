const API_BASE_URL="https://sunnytseng.com/api";let TOKEN=null;const PASSWORD_HASH="2348f998744212575d85959674f9607ab26f67708a917157472832386337c904";function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...o)}),t)}}function disableEnterListener(){document.removeEventListener("keydown",enterKeyListener)}function enableEnterListener(){document.addEventListener("keydown",enterKeyListener)}async function login_and_get_token(){let e=await fetch(`${API_BASE_URL}/login/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:"sunny",password:"open"})}),t=await e.json();TOKEN=t.access}async function fetchTasksFromAPI(){TOKEN||await login_and_get_token();let e=await fetch(`${API_BASE_URL}/get-toDoNotes/`,{method:"GET",headers:{Authorization:`Bearer ${TOKEN}`}});return 401===e.status&&(await login_and_get_token(),e=await fetch(`${API_BASE_URL}/get-toDoNotes/`,{method:"GET",headers:{Authorization:`Bearer ${TOKEN}`}})),e.json()}async function saveTasksToAPI(e){TOKEN||await login_and_get_token();let t=await fetch(`${API_BASE_URL}/save-toDoNotes/`,{method:"POST",headers:{Authorization:`Bearer ${TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(e)});return 401===t.status&&(await login_and_get_token(),t=await fetch(`${API_BASE_URL}/save-toDoNotes/`,{method:"POST",headers:{Authorization:`Bearer ${TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(e)})),t.json()}const todoContainer=document.getElementById("todo-container"),mainTitle=document.getElementById("main-title"),mainContent=document.getElementById("main-content"),noteButton=document.getElementById("note"),saveButton=document.getElementById("save-tasks"),addTaskButton=document.getElementById("add-task"),clearInProgressButton=document.getElementById("clear-in-progress");let noteContainer=null,noteEditor=null;const debouncedSaveTasks=debounce(saveTasks,500);function initializePage(){saveButton.addEventListener("click",saveTasks),addTaskButton.addEventListener("click",addTask),clearInProgressButton.addEventListener("click",clearInProgress),noteButton.addEventListener("click",toggleNote),fetchTasks(),initializeSortable()}function showTodoView(){todoContainer.style.display="block",mainTitle.textContent="To-Do List",noteContainer&&(noteContainer.style.display="none"),noteButton.textContent="Notebook"}function fetchTasks(){fetchTasksFromAPI().then((e=>{e&&"object"==typeof e&&void 0!==e.note_data&&void 0!==e.todo_data&&void 0!==e.in_progress_data?(renderTasks(e.todo_data,"todo-list"),renderTasks(e.in_progress_data,"in-progress-list"),updateNoteContent(e.note_data)):(console.error("Invalid data structure:",e),showErrorMessage("Error","Received invalid data structure from server"),renderTasks([],"todo-list"),renderTasks([],"in-progress-list"),updateNoteContent(""))})).catch((e=>{console.error("Error fetching tasks:",e),showErrorMessage("Error","Unable to fetch tasks and notes: "+e.message),renderTasks([],"todo-list"),renderTasks([],"in-progress-list"),updateNoteContent("")}))}function renderTasks(e,t){const n=document.getElementById(t);n?(n.innerHTML="",e.forEach((e=>{if(void 0!==e.goal&&void 0!==e.purpose&&void 0!==e.todo&&void 0!==e.timing){const o=createTaskElement(e,"in-progress-list"===t);n.appendChild(o)}else console.warn("Invalid task data:",e)}))):console.error(`Element with ID '${t}' not found`)}function createTaskElement(e,t){const n=document.createElement("li");n.className="list-group-item d-flex justify-content-between align-items-center";const o=`${e.goal} ${e.purpose} [ ${e.todo} ] ${e.timing}`;n.textContent=o,n.dataset.taskData=JSON.stringify(e),n.addEventListener("dblclick",(()=>editTask(n)));const r=document.createElement("button");return r.className=t?"btn btn-sm btn-outline-danger":"btn btn-sm btn-outline-success",r.textContent=t?"Complete":"In Progress",r.addEventListener("click",(()=>{t?removeFromInProgress(n):moveToInProgress(n)})),n.appendChild(r),n}function moveToInProgress(e){document.getElementById("in-progress-list").prepend(e);const t=e.querySelector("button");t.className="btn btn-sm btn-outline-danger",t.textContent="Complete",t.onclick=()=>removeFromInProgress(e),debouncedSaveTasks()}function removeFromInProgress(e){e.remove(),debouncedSaveTasks()}function saveTasks(){const e=document.getElementById("todo-list"),t=document.getElementById("in-progress-list"),n=Array.from(e.children).map((e=>JSON.parse(e.dataset.taskData))),o=Array.from(t.children).map((e=>JSON.parse(e.dataset.taskData))),r=noteEditor?noteEditor.getValue().trim():"";if(0===n.length&&0===o.length&&""===r)return void showErrorMessage("Access Denied","The current dataset is empty. The system has blocked the save request to protect existing data.");const i={note_data:r,todo_data:n,in_progress_data:o},s=document.getElementById("save-tasks"),a=s.innerHTML;s.innerHTML='<span class="spinner"></span>',saveTasksToAPI(i).then((e=>{e.success||showErrorMessage("Save Failed","Unable to save: "+(e.message||"Unknown error"))})).catch((e=>{showErrorMessage("Error","Unknown error occurred: "+e.message)})).finally((()=>{s.innerHTML=a}))}function addTask(){disableEnterListener(),Swal.fire({title:"Add Task",input:"text",inputPlaceholder:"Goal, Purpose, Task, Timing",showCancelButton:!0,confirmButtonColor:"#3085d6",confirmButtonText:"Add",inputValidator:e=>{if(!e)return"Please enter task content";return 4!==e.split(",").length?"Please ensure four items are entered, separated by commas":void 0}}).then((e=>{if(enableEnterListener(),e.value){const[t,n,o,r]=e.value.split(","),i={goal:t.trim(),purpose:n.trim(),todo:o.trim(),timing:r.trim()},s=document.getElementById("todo-list"),a=createTaskElement(i,!1);s.prepend(a),debouncedSaveTasks()}}))}function editTask(e){disableEnterListener();const t=JSON.parse(e.dataset.taskData),n=`${t.goal}, ${t.purpose}, ${t.todo}, ${t.timing}`;Swal.fire({title:"Edit Task",input:"text",inputPlaceholder:"Goal, Purpose, Task, Timing",inputValue:n,showCancelButton:!0,confirmButtonColor:"#3085d6",confirmButtonText:"Save",inputValidator:e=>{if(!e)return"Please enter task content";return 4!==e.split(",").length?"Please ensure four items are entered, separated by commas":void 0}}).then((t=>{if(enableEnterListener(),t.value){const[n,o,r,i]=t.value.split(","),s={goal:n.trim(),purpose:o.trim(),todo:r.trim(),timing:i.trim()};e.dataset.taskData=JSON.stringify(s),e.childNodes[0].textContent=`${s.goal} ${s.purpose} [ ${s.todo} ] ${s.timing}`,debouncedSaveTasks()}}))}function clearInProgress(){Swal.fire({title:"Type CONFIRM to clear all In Progress tasks",input:"text",inputPlaceholder:"Enter CONFIRM",showCancelButton:!0,confirmButtonText:"Clear",cancelButtonText:"Cancel",confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",preConfirm:e=>"CONFIRM"===e||(Swal.showValidationMessage("You must type CONFIRM to proceed."),!1)}).then((e=>{e.isConfirmed&&(document.getElementById("in-progress-list").innerHTML="",debouncedSaveTasks(),Swal.fire({icon:"success",title:"Cleared",text:"All In Progress tasks have been removed.",showConfirmButton:!1,timer:1200}))}))}function initializeSortable(){window.matchMedia("(min-width: 768px)").matches&&(new Sortable(document.getElementById("todo-list"),{group:"shared",animation:150,ghostClass:"blue-background-class",onEnd:function(e){if("in-progress-list"===e.to.id){const t=e.item.querySelector("button");t.className="btn btn-sm btn-outline-danger",t.textContent="Complete",t.onclick=()=>removeFromInProgress(e.item)}debouncedSaveTasks()}}),new Sortable(document.getElementById("in-progress-list"),{group:"shared",animation:150,ghostClass:"blue-background-class",onEnd:function(e){if("todo-list"===e.to.id){const t=e.item.querySelector("button");t.className="btn btn-sm btn-outline-success",t.textContent="In Progress",t.onclick=()=>moveToInProgress(e.item)}debouncedSaveTasks()}}))}function enterKeyListener(e){if(e.isComposing)return;const t=document.activeElement,n=t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable);"Enter"!==e.key||n||noteEditor&&noteEditor.hasFocus()||addTaskButton.click()}function tabKeyListener(e){"Tab"!==e.key||noteEditor&&(noteEditor.hasFocus()||isVimModeActive())||(e.preventDefault(),toggleNote())}function isVimModeActive(){return noteEditor&&"vim"===noteEditor.getOption("keyMap")&&noteEditor.state.vim&&noteEditor.state.vim.insertMode}function toggleNote(){"none"!==todoContainer.style.display?(document.removeEventListener("keydown",enterKeyListener),todoContainer.style.display="none",mainTitle.textContent="Notebook",noteContainer?noteContainer.style.display="block":createNoteContainer(),noteButton.textContent="To-Do List"):(document.addEventListener("keydown",enterKeyListener),showTodoView()),document.addEventListener("keydown",tabKeyListener)}function createNoteContainer(){noteContainer=document.createElement("div"),noteContainer.id="note-container",noteContainer.className="container-fluid p-0",mainContent.appendChild(noteContainer);const e=document.createElement("h6");e.className="text-center text-white mt-2",e.innerHTML='<img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/Vimlogo.svg" alt="Vim Logo" style="height: 1.2em; vertical-align: middle; margin-right: 0.4em;"><span style="vertical-align: middle;">Notebook</span>',noteContainer.appendChild(e);const t=window.matchMedia("(min-width: 768px)").matches,n=document.createElement("div");n.id="editor",noteContainer.appendChild(n),noteEditor=CodeMirror(n,{lineNumbers:t,theme:"monokai",mode:{name:"markdown",highlightFormatting:!0},keyMap:"vim",styleActiveLine:!0,foldGutter:!0,gutters:t?["CodeMirror-linenumbers","CodeMirror-foldgutter"]:["CodeMirror-foldgutter"],lineNumberFormatter:e=>{if(!noteEditor)return e;const t=noteEditor.getCursor().line+1;return String(e===t?e:Math.abs(t-e))},extraKeys:{"Ctrl-Q":e=>e.foldCode(e.getCursor()),"Ctrl-C":e=>{const t=e.getSelection();t&&navigator.clipboard.writeText(t)}}}),noteEditor.on("cursorActivity",(()=>{const e=noteEditor.getCursor();noteEditor.scrollIntoView({line:e.line,ch:e.ch},0),setTimeout((()=>noteEditor.refresh()),10)})),CodeMirror.Vim.defineAction("foldCurrent",(e=>e.foldCode(e.getCursor()))),CodeMirror.Vim.defineAction("unfoldCurrent",(e=>e.foldCode(e.getCursor(),null,"unfold"))),CodeMirror.Vim.mapCommand("zc","action","foldCurrent",{}),CodeMirror.Vim.mapCommand("zo","action","unfoldCurrent",{}),CodeMirror.Vim.map("jk","<Esc>","insert"),CodeMirror.Vim.map("L","$","normal"),CodeMirror.Vim.map("H","0","normal"),setTimeout((()=>CodeMirror.Vim.handleKey(noteEditor,"i")),500)}function updateNoteContent(e){noteContainer||createNoteContainer(),noteEditor&&noteEditor.setValue(e||""),noteContainer.style.display="none"}function showErrorMessage(e,t){Swal.fire({icon:"error",title:e,text:t,confirmButtonText:"OK",confirmButtonColor:"#ff9800"})}document.addEventListener("DOMContentLoaded",(async function(){if("true"===sessionStorage.getItem("logged_in"))return document.body.classList.remove("hidden-content"),void initializePage();Swal.fire({title:"Login",input:"password",inputPlaceholder:"Please enter password",showCancelButton:!1,confirmButtonText:"Confirm",confirmButtonColor:"#ff9800",allowOutsideClick:!1,preConfirm:async e=>{if(!e)return Swal.showValidationMessage("Incorrect password, please try again!"),!1;const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")!==PASSWORD_HASH?(Swal.showValidationMessage("Incorrect password, please try again!"),!1):(sessionStorage.setItem("logged_in","true"),!0)}}).then((e=>{e.isConfirmed&&(document.body.classList.remove("hidden-content"),initializePage())})),addTaskButton.focus(),document.addEventListener("keydown",enterKeyListener),document.addEventListener("keydown",tabKeyListener),document.addEventListener("keydown",(function(e){e.ctrlKey&&"s"===e.key&&(e.preventDefault(),saveTasks())}))}));
